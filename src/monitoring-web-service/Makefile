# Fortium AI-Augmented Development - Monitoring Web Service
# Makefile for managing backend, websocket, and frontend services

.PHONY: help install dev start stop backend frontend websocket test clean logs status health signoz-start signoz-stop signoz-logs signoz-clean signoz-validate otel-test

# Colors for output
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[1;33m
BLUE := \033[0;34m
NC := \033[0m # No Color

# Default target
help:
	@echo "$(BLUE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(BLUE)â•‘$(NC)  $(GREEN)Fortium Monitoring Web Service - Development Commands$(NC)       $(BLUE)â•‘$(NC)"
	@echo "$(BLUE)â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£$(NC)"
	@echo "$(BLUE)â•‘$(NC) $(YELLOW)Development:$(NC)                                                   $(BLUE)â•‘$(NC)"
	@echo "$(BLUE)â•‘$(NC)   make install    - Install all dependencies                   $(BLUE)â•‘$(NC)"
	@echo "$(BLUE)â•‘$(NC)   make dev        - Start all services in development mode     $(BLUE)â•‘$(NC)"
	@echo "$(BLUE)â•‘$(NC)   make start      - Start all services (alias for dev)         $(BLUE)â•‘$(NC)"
	@echo "$(BLUE)â•‘$(NC)   make stop       - Stop all running services                  $(BLUE)â•‘$(NC)"
	@echo "$(BLUE)â•‘$(NC)                                                                 $(BLUE)â•‘$(NC)"
	@echo "$(BLUE)â•‘$(NC) $(YELLOW)Individual Services:$(NC)                                           $(BLUE)â•‘$(NC)"
	@echo "$(BLUE)â•‘$(NC)   make backend    - Start backend/websocket server only        $(BLUE)â•‘$(NC)"
	@echo "$(BLUE)â•‘$(NC)   make frontend   - Start frontend dev server only             $(BLUE)â•‘$(NC)"
	@echo "$(BLUE)â•‘$(NC)                                                                 $(BLUE)â•‘$(NC)"
	@echo "$(BLUE)â•‘$(NC) $(YELLOW)Testing & Monitoring:$(NC)                                          $(BLUE)â•‘$(NC)"
	@echo "$(BLUE)â•‘$(NC)   make test       - Run all tests                              $(BLUE)â•‘$(NC)"
	@echo "$(BLUE)â•‘$(NC)   make logs       - Show logs from all services                $(BLUE)â•‘$(NC)"
	@echo "$(BLUE)â•‘$(NC)   make status     - Check service status                       $(BLUE)â•‘$(NC)"
	@echo "$(BLUE)â•‘$(NC)   make health     - Check backend health endpoint              $(BLUE)â•‘$(NC)"
	@echo "$(BLUE)â•‘$(NC)                                                                 $(BLUE)â•‘$(NC)"
	@echo "$(BLUE)â•‘$(NC) $(YELLOW)SignOz Observability:$(NC)                                          $(BLUE)â•‘$(NC)"
	@echo "$(BLUE)â•‘$(NC)   make signoz-start   - Start SignOz observability stack       $(BLUE)â•‘$(NC)"
	@echo "$(BLUE)â•‘$(NC)   make signoz-stop    - Stop SignOz services                   $(BLUE)â•‘$(NC)"
	@echo "$(BLUE)â•‘$(NC)   make signoz-logs    - View SignOz logs                       $(BLUE)â•‘$(NC)"
	@echo "$(BLUE)â•‘$(NC)   make signoz-clean   - Clean SignOz data (caution!)           $(BLUE)â•‘$(NC)"
	@echo "$(BLUE)â•‘$(NC)   make signoz-validate - Validate SignOz integration           $(BLUE)â•‘$(NC)"
	@echo "$(BLUE)â•‘$(NC)   make otel-test      - Test OpenTelemetry integration         $(BLUE)â•‘$(NC)"
	@echo "$(BLUE)â•‘$(NC)                                                                 $(BLUE)â•‘$(NC)"
	@echo "$(BLUE)â•‘$(NC) $(YELLOW)Maintenance:$(NC)                                                   $(BLUE)â•‘$(NC)"
	@echo "$(BLUE)â•‘$(NC)   make clean      - Clean build artifacts and logs             $(BLUE)â•‘$(NC)"
	@echo "$(BLUE)â•‘$(NC)   make restart    - Restart all services                       $(BLUE)â•‘$(NC)"
	@echo "$(BLUE)â•‘$(NC)   make db-reset   - Reset database (caution!)                  $(BLUE)â•‘$(NC)"
	@echo "$(BLUE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"

# Install all dependencies
install:
	@echo "$(YELLOW)ğŸ“¦ Installing backend dependencies...$(NC)"
	@npm install
	@echo "$(YELLOW)ğŸ“¦ Installing frontend dependencies...$(NC)"
	@cd frontend && npm install
	@echo "$(GREEN)âœ… All dependencies installed successfully!$(NC)"

# Start all services in development mode with hot reload
dev:
	@echo "$(BLUE)ğŸš€ Starting all services in development mode with hot reload...$(NC)"
	@make -j 2 backend-watch-bg frontend-bg
	@echo "$(GREEN)âœ… All services started with hot reload!$(NC)"
	@echo ""
	@echo "$(BLUE)ğŸ“Š Service URLs:$(NC)"
	@echo "  Backend API:  $(GREEN)http://localhost:3001$(NC)"
	@echo "  Frontend:     $(GREEN)http://localhost:3000$(NC)"
	@echo "  Health Check: $(GREEN)http://localhost:3001/health$(NC)"
	@echo "  WebSocket:    $(GREEN)ws://localhost:3001$(NC)"
	@echo ""
	@echo "$(YELLOW)ğŸ”¥ Hot reload enabled - changes will auto-restart services$(NC)"
	@echo "$(YELLOW)Press Ctrl+C to stop all services$(NC)"
	@tail -f /dev/null

# Alias for dev
start: dev

# Start backend/websocket server in background
backend-bg:
	@echo "$(YELLOW)ğŸ”§ Starting backend/websocket server...$(NC)"
	@PORT=3001 npx tsx src/app.ts 2>&1 | sed 's/^/[BACKEND] /' &

# Start backend/websocket server with hot reload in background
backend-watch-bg:
	@echo "$(YELLOW)ğŸ”§ Starting backend/websocket server with hot reload...$(NC)"
	@PORT=3001 npx tsx watch src/app.ts 2>&1 | sed 's/^/[BACKEND] /' &

# Start frontend in background
frontend-bg:
	@echo "$(YELLOW)ğŸ¨ Starting frontend dev server...$(NC)"
	@cd frontend && npm run dev 2>&1 | sed 's/^/[FRONTEND] /' &

# Start backend/websocket server only
backend:
	@echo "$(YELLOW)ğŸ”§ Starting backend/websocket server...$(NC)"
	PORT=3001 npx tsx src/app.ts

# Start frontend only
frontend:
	@echo "$(YELLOW)ğŸ¨ Starting frontend dev server...$(NC)"
	cd frontend && npm run dev

# Start websocket server (alias for backend)
websocket: backend

# Stop all services
stop:
	@echo "$(RED)ğŸ›‘ Stopping all services...$(NC)"
	@pkill -f "tsx src/app.ts" || true
	@pkill -f "vite" || true
	@lsof -ti:3001 | xargs kill -9 2>/dev/null || true
	@lsof -ti:3000 | xargs kill -9 2>/dev/null || true
	@echo "$(GREEN)âœ… All services stopped$(NC)"

# Restart all services
restart:
	@make stop
	@sleep 2
	@make dev

# Run tests
test:
	@echo "$(YELLOW)ğŸ§ª Running backend tests...$(NC)"
	@npm test
	@echo "$(YELLOW)ğŸ§ª Running frontend tests...$(NC)"
	@cd frontend && npm test

# Show logs from all services
logs:
	@echo "$(BLUE)ğŸ“‹ Showing recent logs...$(NC)"
	@tail -f *.log 2>/dev/null || echo "$(YELLOW)No log files found. Services may be using console output.$(NC)"

# Check service status
status:
	@echo "$(BLUE)ğŸ“Š Service Status:$(NC)"
	@echo -n "Backend (port 3001): "
	@if lsof -Pi :3001 -sTCP:LISTEN -t >/dev/null ; then \
		echo "$(GREEN)âœ… Running$(NC)"; \
	else \
		echo "$(RED)âŒ Stopped$(NC)"; \
	fi
	@echo -n "Frontend (port 3000): "
	@if lsof -Pi :3000 -sTCP:LISTEN -t >/dev/null ; then \
		echo "$(GREEN)âœ… Running$(NC)"; \
	else \
		echo "$(RED)âŒ Stopped$(NC)"; \
	fi

# Check backend health
health:
	@echo "$(BLUE)ğŸ¥ Checking backend health...$(NC)"
	@curl -s http://localhost:3001/health | jq '.' || echo "$(RED)âŒ Backend is not responding$(NC)"

# Clean build artifacts and logs
clean:
	@echo "$(YELLOW)ğŸ§¹ Cleaning build artifacts...$(NC)"
	@rm -rf dist/
	@rm -rf frontend/dist/
	@rm -rf node_modules/.cache/
	@rm -rf frontend/node_modules/.cache/
	@rm -f *.log
	@echo "$(GREEN)âœ… Clean complete$(NC)"

# Database reset (caution!)
db-reset:
	@echo "$(RED)âš ï¸  WARNING: This will reset the database!$(NC)"
	@echo "Press Ctrl+C to cancel, or wait 5 seconds to continue..."
	@sleep 5
	@echo "$(YELLOW)ğŸ—„ï¸  Resetting database...$(NC)"
	@npx prisma migrate reset --force
	@echo "$(GREEN)âœ… Database reset complete$(NC)"

# Build for production
build:
	@echo "$(YELLOW)ğŸ—ï¸  Building backend...$(NC)"
	@npm run build
	@echo "$(YELLOW)ğŸ—ï¸  Building frontend...$(NC)"
	@cd frontend && npm run build
	@echo "$(GREEN)âœ… Build complete$(NC)"

# Run in production mode
prod:
	@echo "$(BLUE)ğŸš€ Starting in production mode...$(NC)"
	@NODE_ENV=production node dist/server-websocket.js &
	@cd frontend && npm run preview &
	@echo "$(GREEN)âœ… Production servers started$(NC)"

# Docker commands
docker-up:
	@echo "$(BLUE)ğŸ³ Starting services with Docker Compose...$(NC)"
	@docker-compose up -d
	@echo "$(GREEN)âœ… Docker services started$(NC)"

docker-down:
	@echo "$(RED)ğŸ³ Stopping Docker services...$(NC)"
	@docker-compose down
	@echo "$(GREEN)âœ… Docker services stopped$(NC)"

docker-logs:
	@docker-compose logs -f

# Development with auto-reload
watch:
	@echo "$(BLUE)ğŸ‘ï¸  Starting services with auto-reload...$(NC)"
	@make -j 2 backend-watch frontend-bg

backend-watch:
	@echo "$(YELLOW)ğŸ”§ Starting backend with auto-reload...$(NC)"
	@PORT=3001 npx tsx watch src/app.ts

# Seed test data
seed:
	@echo "$(YELLOW)ğŸŒ± Seeding test data...$(NC)"
	@npx tsx scripts/seed-test-data.ts
	@echo "$(GREEN)âœ… Test data seeded$(NC)"

# Open dashboard in browser
open:
	@echo "$(BLUE)ğŸŒ Opening dashboard in browser...$(NC)"
	@open http://localhost:5173 || xdg-open http://localhost:5173 || echo "Please open http://localhost:5173 in your browser"

# Quick start (install, then dev)
quickstart: install dev open

# Check if all prerequisites are installed
check-deps:
	@echo "$(BLUE)ğŸ” Checking dependencies...$(NC)"
	@command -v node >/dev/null 2>&1 || { echo "$(RED)âŒ Node.js is not installed$(NC)"; exit 1; }
	@command -v npm >/dev/null 2>&1 || { echo "$(RED)âŒ npm is not installed$(NC)"; exit 1; }
	@echo "$(GREEN)âœ… All dependencies found$(NC)"
	@echo "  Node version: $$(node --version)"
	@echo "  npm version: $$(npm --version)"

# SignOz Observability Platform Commands
signoz-start:
	@echo "$(BLUE)ğŸ” Starting SignOz observability stack...$(NC)"
	@docker-compose -f docker-compose.signoz.yml up -d
	@echo "$(GREEN)âœ… SignOz services starting...$(NC)"
	@echo "$(YELLOW)ğŸ“Š SignOz UI will be available at: http://localhost:3301$(NC)"
	@echo "$(YELLOW)ğŸ”— OTLP Endpoint: http://localhost:4318$(NC)"
	@echo "$(YELLOW)â³ Please wait 60-90 seconds for all services to be ready$(NC)"

signoz-stop:
	@echo "$(BLUE)ğŸ›‘ Stopping SignOz observability stack...$(NC)"
	@docker-compose -f docker-compose.signoz.yml down
	@echo "$(GREEN)âœ… SignOz services stopped$(NC)"

signoz-logs:
	@echo "$(BLUE)ğŸ“‹ Showing SignOz service logs...$(NC)"
	@docker-compose -f docker-compose.signoz.yml logs -f

signoz-clean:
	@echo "$(RED)âš ï¸  WARNING: This will delete all SignOz data including traces and metrics!$(NC)"
	@read -p "Are you sure? Type 'yes' to continue: " confirm && [ "$$confirm" = "yes" ] || exit 1
	@echo "$(BLUE)ğŸ§¹ Cleaning SignOz data and containers...$(NC)"
	@docker-compose -f docker-compose.signoz.yml down -v
	@docker system prune -f
	@echo "$(GREEN)âœ… SignOz data cleaned$(NC)"

signoz-validate:
	@echo "$(BLUE)ğŸ” Validating SignOz integration...$(NC)"
	@npx tsx scripts/validate-signoz-integration.ts

otel-test:
	@echo "$(BLUE)ğŸ§ª Testing OpenTelemetry integration...$(NC)"
	@npx tsx scripts/test-otel-integration.ts

# Combined observability setup
observability-setup: signoz-start
	@echo "$(YELLOW)â³ Waiting for SignOz to initialize...$(NC)"
	@sleep 60
	@make signoz-validate
	@echo "$(GREEN)ğŸ‰ SignOz observability platform is ready!$(NC)"
	@echo "$(CYAN)ğŸ“Š Access SignOz UI: http://localhost:3301$(NC)"
	@echo "$(CYAN)ğŸ” Generate test data: make otel-test$(NC)"

# Start application with observability
dev-otel: signoz-start
	@echo "$(YELLOW)â³ Waiting for SignOz services...$(NC)"
	@sleep 30
	@echo "$(BLUE)ğŸš€ Starting application with OpenTelemetry...$(NC)"
	@npm run dev:otel
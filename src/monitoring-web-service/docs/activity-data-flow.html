<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<title>activity-data-flow.html</title>
<meta http-equiv="Content-Type" content="application/xhtml+xml;charset=utf-8"/>
<link rel="stylesheet" type="text/css" media="all" href="https://cdn.jsdelivr.net/npm/github-markdown-css/github-markdown.min.css"  />
<link rel="stylesheet" type="text/css" media="all" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/styles/github.min.css"  /><meta name='viewport' content='width=device-width, initial-scale=1, shrink-to-fit=no'><style> body { box-sizing: border-box; max-width: 740px; width: 100%; margin: 40px auto; padding: 0 10px; } </style><script id='MathJax-script' async src='https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'></script><script src='https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/highlight.min.js'></script><script>document.addEventListener('DOMContentLoaded', () => { document.body.classList.add('markdown-body'); document.querySelectorAll('pre[lang] > code').forEach((code) => { code.classList.add(code.parentElement.lang); }); document.querySelectorAll('pre > code').forEach((code) => { hljs.highlightBlock(code); }); });</script>
</head>

<body>

[WARNING] Deprecated: --highlight-style. Use --syntax-highlighting instead.
<h1 id="activity-data-flow-architecture">Activity Data Flow
Architecture</h1>
<p>This document describes how activity data flows through the
monitoring web service system, from Claude Code usage to real-time
frontend updates.</p>
<h2 id="system-overview">System Overview</h2>
<p>The activity tracking system captures user interactions with Claude
Code and displays them in real-time through a web interface. The flow
involves hooks, APIs, database storage, and WebSocket broadcasting.</p>
<h2 id="activity-data-flow-diagram">Activity Data Flow Diagram</h2>
<pre class="mermaid"><code>graph TD
    %% Source: Claude Code Usage
    A[Claude Code Session] --&gt;|User executes commands/tools| B[Hooks System]

    %% Hooks Processing
    B --&gt;|Pre-execution| C[Pre Hook]
    B --&gt;|Post-execution| D[Post Hook]
    C --&gt;|Generates activity data| E[Metrics API Client]
    D --&gt;|Generates activity data| E

    %% API Client &amp; Authentication
    E --&gt;|HTTP POST with auth token| F[Activities API Endpoint&lt;br&gt;/api/v1/activities]
    E --&gt;|Gets token from profile| G[User Profile&lt;br&gt;~/.ai-mesh/profile/user.json]
    G -.-&gt;|Provides auth token| E

    %% API Processing
    F --&gt;|1. Validate request| H[Development Auth Middleware]
    H --&gt;|Creates mock user context| I[User Validation]
    I --&gt;|2. Ensure user exists| J[ensureUserExists Function]
    J --&gt;|Creates user if needed| K[(PostgreSQL Database&lt;br&gt;fortium_schema.user)]

    %% Database Operations
    I --&gt;|3. Write activity| L[(PostgreSQL Database&lt;br&gt;fortium_schema.activity_data)]
    L --&gt;|Returns created activity| M[Transform to Response Format]

    %% WebSocket Broadcasting
    M --&gt;|4. Broadcast to WebSocket| N[WebSocket Manager]
    N --&gt;|broadcastActivityEvent| O[WebSocket Service]
    O --&gt;|Sends &#39;activity_created&#39; event| P[Connected WebSocket Clients]

    %% Frontend Integration
    P --&gt;|Real-time event| Q[Frontend WebSocket Hook&lt;br&gt;useActivityStream]
    Q --&gt;|Updates state| R[Real-time Activity Feed Widget]
    L --&gt;|Also available via| S[GET /api/v1/activities]
    S --&gt;|HTTP polling fallback| R

    %% Response Flow
    M --&gt;|5. Return success| T[HTTP 201 Response]
    T --&gt;|Success confirmation| E
    E --&gt;|Hook completes| B

    %% Error Handling
    F -.-&gt;|If user creation fails| U[HTTP 400 Error]
    F -.-&gt;|If DB write fails| V[HTTP 500 Error]
    N -.-&gt;|If WebSocket fails| W[Log warning but continue]

    %% Styling
    classDef database fill:#e1f5fe
    classDef api fill:#f3e5f5
    classDef websocket fill:#e8f5e8
    classDef frontend fill:#fff3e0
    classDef hooks fill:#fce4ec

    class K,L database
    class F,H,I,J,M,S api
    class N,O,P websocket
    class Q,R frontend
    class A,B,C,D,E,G hooks</code></pre>
<h2 id="detailed-flow-description">Detailed Flow Description</h2>
<h3 id="data-generation-hooks-system">1. Data Generation (Hooks
System)</h3>
<ul>
<li><strong>Source</strong>: Claude Code user executes
commands/tools</li>
<li><strong>Pre Hook</strong>: Captures command start events
(<code>hooks/tool-metrics.js</code>)</li>
<li><strong>Post Hook</strong>: Captures command completion events with
duration</li>
<li><strong>Metrics API Client</strong>: Sends HTTP POST to
<code>/api/v1/activities</code> with authentication</li>
</ul>
<h3 id="api-processing-activities.routes.ts">2. API Processing
(activities.routes.ts)</h3>
<ul>
<li><strong>Authentication</strong>: Development middleware creates mock
user context</li>
<li><strong>User Validation</strong>: <code>ensureUserExists()</code>
function ensures demo user exists in database</li>
<li><strong>Database Write</strong>: Activity data saved to
<code>fortium_schema.activity_data</code> table</li>
<li><strong>Response Transform</strong>: Database record converted to
standardized API response format</li>
</ul>
<h3 id="real-time-broadcasting-websocket-integration">3. Real-time
Broadcasting (WebSocket Integration)</h3>
<ul>
<li><strong>WebSocket Manager</strong>: Retrieved from Express app
context (<code>req.app.wsManager</code>)</li>
<li><strong>Broadcast Event</strong>: Calls
<code>broadcastActivityEvent('1', {type: 'activity_created', activity})</code></li>
<li><strong>WebSocket Service</strong>: Distributes real-time events to
connected clients</li>
<li><strong>Error Handling</strong>: WebSocket failures are logged but
don’t affect API response</li>
</ul>
<h3 id="frontend-integration">4. Frontend Integration</h3>
<ul>
<li><strong>WebSocket Hook</strong>: <code>useActivityStream</code>
receives real-time events via WebSocket</li>
<li><strong>Activity Widget</strong>: Updates immediately when new
activities are broadcast</li>
<li><strong>HTTP Fallback</strong>: Can poll
<code>GET /api/v1/activities</code> for data if WebSocket
unavailable</li>
</ul>
<h2 id="key-components">Key Components</h2>
<h3 id="database-schema">Database Schema</h3>
<div class="sourceCode" id="cb2"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- fortium_schema.user table</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> <span class="fu">user</span> (</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> UUID <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    email <span class="dt">VARCHAR</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    firstName <span class="dt">VARCHAR</span>,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    lastName <span class="dt">VARCHAR</span>,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">role</span> <span class="dt">VARCHAR</span>,</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    tenantId <span class="dt">VARCHAR</span>,</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    isActive <span class="dt">BOOLEAN</span>,</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    createdAt <span class="dt">TIMESTAMP</span>,</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    updatedAt <span class="dt">TIMESTAMP</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co">-- fortium_schema.activity_data table</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> activity_data (</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> UUID <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    actionName <span class="dt">VARCHAR</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    actionDescription <span class="dt">VARCHAR</span>,</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    targetName <span class="dt">VARCHAR</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    status <span class="dt">VARCHAR</span>,</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    duration <span class="dt">INTEGER</span>,</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    isAutomated <span class="dt">BOOLEAN</span>,</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    priority <span class="dt">INTEGER</span>,</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    <span class="dt">timestamp</span> <span class="dt">TIMESTAMP</span>,</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    userId UUID <span class="kw">REFERENCES</span> <span class="fu">user</span>(<span class="kw">id</span>)</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>);</span></code></pre></div>
<h3 id="api-endpoints">API Endpoints</h3>
<ul>
<li><strong>POST /api/v1/activities</strong>: Create new activity</li>
<li><strong>POST /api/v1/activities/test</strong>: Create test activity
for WebSocket testing</li>
<li><strong>GET /api/v1/activities</strong>: Retrieve activities with
pagination and filtering</li>
<li><strong>GET /api/v1/activities/summary</strong>: Get activity
statistics</li>
</ul>
<h3 id="websocket-events">WebSocket Events</h3>
<ul>
<li><strong>activity_created</strong>: Broadcast when new activity is
created</li>
<li><strong>Connection Path</strong>: <code>/ws</code></li>
<li><strong>Authentication</strong>: JWT token-based (development mode
uses mock auth)</li>
</ul>
<h2 id="authentication-flow">Authentication Flow</h2>
<h3 id="development-mode">Development Mode</h3>
<div class="sourceCode" id="cb3"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Development auth middleware creates mock user</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>req<span class="op">.</span><span class="at">user</span> <span class="op">=</span> {</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">userId</span><span class="op">:</span> <span class="st">&#39;8985da03-bd7f-4316-9316-afd59d319c13&#39;</span><span class="op">,</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">tenantId</span><span class="op">:</span> <span class="st">&#39;a1b2c3d4-e5f6-4789-a012-345678901234&#39;</span><span class="op">,</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">email</span><span class="op">:</span> <span class="st">&#39;demo@fortium.com&#39;</span><span class="op">,</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">role</span><span class="op">:</span> <span class="st">&#39;admin&#39;</span><span class="op">,</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">permissions</span><span class="op">:</span> [<span class="st">&#39;read&#39;</span><span class="op">,</span> <span class="st">&#39;write&#39;</span><span class="op">,</span> <span class="st">&#39;admin&#39;</span>]</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="user-profile-system">User Profile System</h3>
<ul>
<li><strong>Location</strong>:
<code>~/.ai-mesh/profile/user.json</code></li>
<li><strong>Purpose</strong>: Stores user identity and authentication
token for hooks</li>
<li><strong>Auto-creation</strong>: Development user created
automatically if missing from database</li>
</ul>
<h2 id="error-handling">Error Handling</h2>
<h3 id="database-errors">Database Errors</h3>
<ul>
<li><strong>Foreign Key Constraints</strong>: Returns HTTP 400 with
specific error message</li>
<li><strong>Connection Issues</strong>: Returns HTTP 500 with generic
error message</li>
<li><strong>User Creation Failures</strong>: Returns HTTP 400 before
attempting activity creation</li>
</ul>
<h3 id="websocket-errors">WebSocket Errors</h3>
<ul>
<li><strong>Connection Failures</strong>: Logged as warnings, don’t
affect API response</li>
<li><strong>Broadcast Failures</strong>: Activity still saved to
database, WebSocket notification skipped</li>
</ul>
<h3 id="resilience-features">Resilience Features</h3>
<ul>
<li><strong>Graceful Degradation</strong>: System works without
WebSocket connectivity</li>
<li><strong>Automatic User Creation</strong>: Missing users created
automatically in development</li>
<li><strong>Comprehensive Logging</strong>: All errors logged with
context for debugging</li>
</ul>
<h2 id="performance-characteristics">Performance Characteristics</h2>
<h3 id="response-times-typical">Response Times (Typical)</h3>
<ul>
<li><strong>Database Write</strong>: 10-50ms</li>
<li><strong>WebSocket Broadcast</strong>: 1-5ms</li>
<li><strong>Total API Response</strong>: 50-100ms</li>
</ul>
<h3 id="scalability-considerations">Scalability Considerations</h3>
<ul>
<li><strong>Database Connection Pooling</strong>: Configured for optimal
performance</li>
<li><strong>WebSocket Connection Limits</strong>: Max 1000 concurrent
connections</li>
<li><strong>Tenant Isolation</strong>: Multi-tenant architecture with
schema-based separation</li>
</ul>
<h2 id="configuration">Configuration</h2>
<h3 id="environment-variables">Environment Variables</h3>
<div class="sourceCode" id="cb4"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Database</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="va">DATABASE_URL</span><span class="op">=</span><span class="st">&quot;postgresql://user:pass@localhost:5432/metrics_development&quot;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Server</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="va">PORT</span><span class="op">=</span>3001</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="va">NODE_ENV</span><span class="op">=</span>development</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co"># WebSocket</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="va">CORS_ORIGIN</span><span class="op">=</span>http://localhost:3001,http://localhost:3000</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Metrics API (for hooks)</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="va">METRICS_API_URL</span><span class="op">=</span>http://localhost:3001/api/v1</span></code></pre></div>
<h3 id="key-files">Key Files</h3>
<ul>
<li><strong>Activities Routes</strong>:
<code>src/routes/activities.routes.ts</code></li>
<li><strong>WebSocket Service</strong>:
<code>src/services/websocket.service.ts</code></li>
<li><strong>Hooks Client</strong>:
<code>hooks/metrics-api-client.js</code></li>
<li><strong>Frontend Hook</strong>:
<code>frontend/src/hooks/useActivityStream.ts</code></li>
<li><strong>App Integration</strong>: <code>src/app.ts</code> (WebSocket
manager attachment)</li>
</ul>
<h2 id="monitoring-and-debugging">Monitoring and Debugging</h2>
<h3 id="logging">Logging</h3>
<ul>
<li><strong>Activity Creation</strong>: Logged with activity ID and user
context</li>
<li><strong>WebSocket Events</strong>: Broadcast success/failure
logged</li>
<li><strong>Database Operations</strong>: Errors logged with stack
traces</li>
<li><strong>Performance Metrics</strong>: OpenTelemetry integration for
detailed tracing</li>
</ul>
<h3 id="debug-endpoints">Debug Endpoints</h3>
<ul>
<li><strong>GET /api/v1/activities/summary</strong>: Activity
statistics</li>
<li><strong>POST /api/v1/activities/test</strong>: WebSocket testing
endpoint</li>
</ul>
<p>This architecture ensures reliable activity tracking with real-time
updates while maintaining data consistency and providing comprehensive
error handling.</p>

</body>
</html>

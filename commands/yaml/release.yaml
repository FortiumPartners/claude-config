metadata:
  name: release
  description: |
    CI/CD-aware NPM package release workflow with GitHub Actions integration. Prepares release
    readiness, creates PR that triggers automated CI/CD pipelines, monitors execution, and
    validates NPM package availability post-merge.
  version: 2.0.0
  lastUpdated: "2025-11-07"
  category: deployment
  output_path: ai-mesh/release.md
  source: fortium

mission:
  summary: |
    This command orchestrates the NPM package release workflow as a "Release Readiness Gate"
    that prepares releases for CI/CD automation. It delegates to release-agent for workflow
    orchestration, which validates release readiness, creates release PRs that trigger GitHub
    Actions workflows, monitors CI/CD pipeline execution, and verifies NPM package availability.

workflow:
  phases:
    - name: Release Initialization
      order: 1
      steps:
        - order: 1
          title: Version Validation
          description: Validate semantic version format (X.Y.Z)
          actions:
            - Parse --version argument
            - Validate semantic versioning format via semantic-version-validator skill
            - Check for version conflicts (tag/branch exists)
          skill: semantic-version-validator
          timing:
            target: 30 seconds

        - order: 2
          title: Release Type Validation
          description: Validate release type and workflow selection
          actions:
            - Parse --type argument (standard, hotfix)
            - Determine base branch (main for standard, production for hotfix)
            - Determine target branch (release/vX.Y.Z, hotfix/vX.Y.Z)
            - Validate branch arguments if provided
          timing:
            target: 10 seconds

        - order: 3
          title: Release Branch Creation
          description: Create release branch via git-workflow
          delegation:
            agent: git-workflow
            context: Base and target branches, release version
          actions:
            - Create release branch from base
            - Push to remote
            - Verify branch created successfully
          timing:
            target: 30 seconds

        - order: 4
          title: Changelog Generation
          description: Generate changelog from git history
          skill: changelog-generator
          actions:
            - Parse commits since last release
            - Categorize changes (breaking, new, enhancement, bugfix)
            - Generate markdown formatted changelog
            - Add changelog to release branch
          timing:
            target: 1 minute

        - order: 5
          title: Version Bump in package.json
          description: Update package.json version and commit
          delegation:
            agent: git-workflow
            context: Release version, package.json path
          actions:
            - Update package.json version field
            - Commit with conventional format (chore(release): bump version to X.Y.Z)
            - Push to remote
          timing:
            target: 30 seconds

    - name: Local Quality Gates (Pre-CI Validation)
      order: 2
      steps:
        - order: 1
          title: Quick Security Pre-Scan
          description: Execute fast security scan before CI/CD
          delegation:
            agent: code-reviewer
            context: Release branch, security pre-scan operation
          timing:
            target: 2 minutes
            timeout: 5 minutes
          actions:
            - Scan for OWASP Top 10 vulnerabilities (critical checks only)
            - Check for critical and high-severity issues
            - Block on critical/high issues

        - order: 2
          title: Definition of Done Validation
          description: Validate DoD categories before CI/CD
          delegation:
            agent: code-reviewer
            context: Release branch, DoD validation operation
          timing:
            target: 2 minutes
            timeout: 5 minutes
          actions:
            - Validate all 8 DoD categories
            - Focus on critical categories for fast validation
            - Block on any category failure

        - order: 3
          title: Version Consistency Check
          description: Verify package.json matches release version
          actions:
            - Read package.json version field
            - Compare with release version argument
            - Block on mismatch
          timing:
            target: 10 seconds

        - order: 4
          title: CHANGELOG.md Verification
          description: Ensure CHANGELOG.md is updated
          actions:
            - Check CHANGELOG.md exists
            - Verify recent updates (git diff)
            - Block if not updated
          timing:
            target: 10 seconds

        - order: 5
          title: Uncommitted Changes Detection
          description: Ensure working tree is clean
          actions:
            - Run git status
            - Check for uncommitted changes
            - Block if working tree not clean
          timing:
            target: 10 seconds

        - order: 6
          title: Dependencies Audit
          description: Quick npm audit check
          actions:
            - Run npm audit --audit-level=high
            - Check for high-severity vulnerabilities
            - Block on high-severity findings
          timing:
            target: 30 seconds

    - name: PR Creation & CI/CD Trigger
      order: 3
      steps:
        - order: 1
          title: Create Release Pull Request
          description: Create PR that triggers GitHub Actions workflows
          delegation:
            agent: github-specialist
            context: |
              Release branch, main branch, changelog from changelog-generator skill,
              pre-CI validation results, CI/CD workflow expectations
          actions:
            - Create PR with comprehensive release information
            - Add release summary from changelog
            - Include pre-CI validation results
            - Document CI/CD workflow expectations
            - Add labels (release, version type, npm-package)
            - Assign reviewers (tech-lead, product-manager)
            - Link to release artifacts
          timing:
            target: 1 minute
          expectedOutput:
            - PR URL
            - PR number
            - Assigned reviewers confirmation
            - CI/CD workflows triggered automatically

    - name: CI/CD Monitoring
      order: 4
      steps:
        - order: 1
          title: Monitor npm-release.yml Workflow
          description: Track NPM Release Pipeline execution
          actions:
            - Poll workflow status via GitHub API (gh run list)
            - Track cross-platform tests (Ubuntu, Windows, macOS)
            - Track Node version tests (18.x, 20.x)
            - Monitor security audit execution
            - Monitor package build validation
            - Report progress in real-time
          timing:
            target: 18 minutes
            timeout: 30 minutes
            pollInterval: 30 seconds

        - order: 2
          title: Monitor ci-cd.yml Workflow
          description: Track CI/CD Pipeline execution
          actions:
            - Poll workflow status via GitHub API
            - Track configuration validation
            - Track security scanning (Trivy)
            - Monitor installation tests
            - Report progress in real-time
          timing:
            target: 7 minutes
            timeout: 15 minutes
            pollInterval: 30 seconds

        - order: 3
          title: Monitor test.yml Workflow
          description: Track Test Suite execution
          actions:
            - Poll workflow status via GitHub API
            - Track unit tests (≥80% coverage target)
            - Track integration tests (≥70% coverage target)
            - Track CLI tests
            - Track API tests
            - Report progress in real-time
          timing:
            target: 7 minutes
            timeout: 15 minutes
            pollInterval: 30 seconds

        - order: 4
          title: Validate All Workflows Passed
          description: Ensure all CI/CD checks succeeded
          actions:
            - Check all workflows completed successfully
            - Block on any workflow failure
            - Link to failed workflow runs if failures detected
            - Extract error context from failed workflows
          timing:
            target: 1 minute

    - name: Release Artifacts
      order: 5
      steps:
        - order: 1
          title: Generate Release Report
          description: Create comprehensive release report with CI/CD results
          skill: release-report-generator
          actions:
            - Compile release summary
            - Include pre-CI validation results
            - Include CI/CD execution results (all workflows)
            - Add timing metrics (local work + CI/CD execution)
            - Include links to PR, workflows, artifacts
          timing:
            target: 1 minute

        - order: 2
          title: Append Audit Log
          description: Record release in audit log with CI/CD tracking
          skill: audit-log-generator
          actions:
            - Append audit log entry with release event
            - Include pre-CI validation tracking
            - Include CI/CD execution tracking
            - Record PR creation and workflow triggers
            - Add release artifacts links
          timing:
            target: 30 seconds

        - order: 3
          title: Update Tickets
          description: Update Linear/Jira tickets with release info
          actions:
            - Update ticket status to "ready-for-merge"
            - Attach release report
            - Link to PR and CI/CD workflows
            - Add pre-CI validation results
          timing:
            target: 30 seconds

        - order: 4
          title: Send Release Metrics
          description: Report metrics to manager-dashboard-agent
          delegation:
            agent: manager-dashboard-agent
            context: Release metrics, cycle time, CI/CD results
          actions:
            - Send cycle time metric
            - Send CI/CD execution status
            - Send pre-CI validation metrics
            - Send workflow timing metrics
          timing:
            target: 30 seconds

    - name: Post-Merge Validation
      order: 6
      condition: PR merged to main
      trigger: Manual after PR approval and merge
      steps:
        - order: 1
          title: Monitor NPM Publish Workflow
          description: Track automatic NPM publish after merge
          actions:
            - Wait for NPM Release Pipeline to trigger (push to main)
            - Monitor workflow execution via GitHub API
            - Track version change detection
            - Track NPM publish operation
            - Track GitHub release creation
            - Report progress in real-time
          timing:
            target: 5 minutes
            timeout: 10 minutes
            pollInterval: 30 seconds

        - order: 2
          title: Verify NPM Package Availability
          description: Confirm package published to NPM registry
          actions:
            - Wait 60 seconds for NPM propagation
            - Check package availability (npm view @fortium/ai-mesh@version)
            - Verify version matches release version
            - Block on package not available
          timing:
            target: 2 minutes
            timeout: 5 minutes

        - order: 3
          title: Execute Final Smoke Tests
          description: Validate NPM package installation and functionality
          actions:
            - Test npx installation (npx @fortium/ai-mesh@version --version)
            - Test CLI help command (npx @fortium/ai-mesh@version --help)
            - Test validation command (npx @fortium/ai-mesh@version validate)
            - Verify all smoke tests pass
          timing:
            target: 2 minutes
            timeout: 5 minutes

        - order: 4
          title: Verify GitHub Release Created
          description: Confirm GitHub release exists
          actions:
            - Check GitHub release via API (gh release view vX.Y.Z)
            - Extract release URL
            - Report completion with URLs
          timing:
            target: 1 minute

        - order: 5
          title: Update Tickets (Release Complete)
          description: Update tickets with final release information
          actions:
            - Update ticket status to "released"
            - Add NPM package URL
            - Add GitHub release URL
            - Add release completion timestamp
          timing:
            target: 30 seconds

arguments:
  required:
    - name: --version
      type: string
      format: X.Y.Z
      description: Semantic version for the release (e.g., 2.1.0)
      validation:
        - Matches semantic versioning format (X.Y.Z)
        - No conflicts with existing tags/branches
      example: --version 2.1.0

  optional:
    - name: --type
      type: enum
      values: [standard, hotfix]
      default: standard
      description: Release type (standard or hotfix)
      example: --type hotfix

    - name: --from
      type: string
      description: Base branch for release (overrides default)
      default: main (standard), production (hotfix)
      example: --from develop

    - name: --to
      type: string
      description: Target branch for release (overrides default)
      default: release/vX.Y.Z (standard), hotfix/vX.Y.Z (hotfix)
      example: --to release/v2.1.0

    - name: --base
      type: string
      description: Alias for --from (base branch)
      example: --base main

    - name: --target
      type: string
      description: Alias for --to (target branch)
      example: --target release/v2.1.0

    - name: --dry-run
      type: boolean
      description: Simulate release workflow without mutations (future enhancement)
      example: --dry-run

expectedInput:
  format: Command arguments
  required:
    - Release version (semantic versioning X.Y.Z)

  optional:
    - Release type (standard, hotfix)
    - Base branch (main, production)
    - Target branch (release/vX.Y.Z, hotfix/vX.Y.Z)
    - Dry-run flag (future)

expectedOutput:
  format: Release workflow results
  structure:
    - name: Release Initialization Results
      description: Version validation, release branch creation, changelog generation, version bump

    - name: Pre-CI Validation Results
      description: Security pre-scan, DoD validation, version consistency, CHANGELOG verification

    - name: PR Creation Results
      description: Pull request URL, PR number, reviewers assigned, CI/CD workflows triggered

    - name: CI/CD Monitoring Results
      description: |
        - npm-release.yml: Cross-platform tests, security audit, package build
        - ci-cd.yml: Configuration validation, security scanning
        - test.yml: Unit tests, integration tests, coverage reports

    - name: Release Artifacts
      description: Release report, audit log, ticket updates, metrics sent

    - name: Post-Merge Validation Results
      description: NPM publish workflow status, package availability, smoke tests, GitHub release

usageExamples:
  - name: Standard NPM Package Release
    command: /release --version 2.1.0
    description: |
      Execute standard release workflow with full pre-CI validation, PR creation that triggers
      GitHub Actions, CI/CD monitoring, and post-merge NPM package validation

  - name: Hotfix Release
    command: /release --version 2.1.1 --type hotfix
    description: |
      Execute fast-track hotfix workflow with streamlined pre-CI validation (5min vs 7min),
      expedited review process, automated backport to develop

  - name: Custom Branches
    command: /release --version 2.1.0 --from develop --to release/v2.1.0
    description: Release from custom base branch to custom target branch

  - name: Dry Run (Future)
    command: /release --version 2.1.0 --dry-run
    description: Simulate release workflow without mutations for testing

timingBudget:
  standardRelease:
    releaseInitialization: 2 minutes
    preCIValidation: 5 minutes
    prCreation: 1 minute
    cicdMonitoring: 20 minutes  # Parallel workflows
    releaseArtifacts: 2 minutes
    postMergeValidation: 5 minutes  # After manual PR merge
    total: 30 minutes (local work) + 20 minutes (CI/CD, async)

  hotfixRelease:
    releaseInitialization: 2 minutes
    preCIValidation: 3 minutes  # Streamlined
    prCreation: 1 minute
    cicdMonitoring: 15 minutes  # Expedited
    releaseArtifacts: 2 minutes
    postMergeValidation: 3 minutes  # After manual PR merge
    total: 26 minutes

qualityGates:
  preCIValidation:
    - name: Security Pre-Scan
      target: Zero critical/high severity issues
      timeout: 5 minutes

    - name: DoD Validation
      target: All 8 categories pass
      timeout: 5 minutes

    - name: Version Consistency
      target: package.json matches release version
      timeout: 10 seconds

    - name: CHANGELOG.md Updated
      target: Recent updates detected
      timeout: 10 seconds

    - name: Working Tree Clean
      target: No uncommitted changes
      timeout: 10 seconds

    - name: Dependencies Audit
      target: No high-severity vulnerabilities
      timeout: 30 seconds

  cicdWorkflows:
    - name: NPM Release Pipeline (npm-release.yml)
      target: All cross-platform tests pass
      timeout: 30 minutes
      checks:
        - Test on Ubuntu, Windows, macOS
        - Node 18.x and 20.x compatibility
        - Security audit passes
        - Package build succeeds

    - name: CI/CD Pipeline (ci-cd.yml)
      target: All validation checks pass
      timeout: 15 minutes
      checks:
        - Agent configuration validation
        - Command configuration validation
        - Hook syntax validation
        - Trivy security scan passes

    - name: Test Suite (test.yml)
      target: All tests pass with coverage
      timeout: 15 minutes
      checks:
        - Unit tests ≥80% coverage
        - Integration tests ≥70% coverage
        - CLI tests pass
        - API tests pass

  postMergeValidation:
    - name: NPM Publish
      target: Package published successfully
      timeout: 10 minutes

    - name: Package Availability
      target: Package available on NPM within 60s
      timeout: 5 minutes

    - name: Smoke Tests
      target: All installation and CLI tests pass
      timeout: 5 minutes

    - name: GitHub Release
      target: Release created with correct version
      timeout: 2 minutes

successCriteria:
  - All pre-CI validation checks pass
  - Release PR created with comprehensive information
  - All GitHub Actions workflows pass (npm-release.yml, ci-cd.yml, test.yml)
  - Release artifacts generated (report, audit log, ticket updates)
  - PR approved and merged (manual step)
  - NPM package published successfully
  - NPM package available and validated via smoke tests
  - GitHub release created

failureCriteria:
  - Any pre-CI validation check fails
  - Version validation fails
  - Release branch creation fails
  - PR creation fails
  - Any CI/CD workflow fails
  - NPM publish workflow fails
  - NPM package not available after publish
  - Smoke tests fail

cicdIntegration:
  workflows:
    - name: npm-release.yml
      description: NPM Release Pipeline
      trigger: PR creation to main
      executionTime: ~18 minutes
      platforms: [ubuntu-latest, windows-latest, macos-latest]
      nodeVersions: ['18.x', '20.x']
      deliverables:
        - Cross-platform test results
        - Security audit report
        - Package tarball
        - Installation validation

    - name: ci-cd.yml
      description: CI/CD Pipeline
      trigger: PR creation to main
      executionTime: ~7 minutes
      deliverables:
        - Configuration validation results
        - Security scan results (Trivy)
        - Installation test results

    - name: test.yml
      description: Test Suite
      trigger: PR creation to main
      executionTime: ~7 minutes
      deliverables:
        - Unit test results (≥80% coverage)
        - Integration test results (≥70% coverage)
        - CLI test results
        - API test results

  postMerge:
    - name: Auto NPM Publish
      description: Automatic NPM publish on version change
      trigger: Push to main with version change in package.json
      workflow: npm-release.yml
      executionTime: ~5 minutes
      deliverables:
        - NPM package published to registry
        - GitHub release created
        - Post-release validation results

notes:
  - name: CI/CD Philosophy
    description: |
      This release command is a "Release Readiness Gate" that prepares releases for CI/CD
      automation. It does NOT manually deploy or publish - GitHub Actions handles all
      deployment automation after PR merge.

  - name: Manual PR Merge
    description: |
      After CI/CD workflows pass, the PR must be manually reviewed and merged. This ensures
      human oversight before NPM package publish. The merge to main automatically triggers
      NPM publish workflow.

  - name: NPM Package Scope
    description: |
      This command is designed for NPM package releases (@fortium/ai-mesh), not traditional
      service deployments. Concepts like staging/production deployment and canary rollouts
      do not apply to NPM packages.

  - name: Rollback Strategy
    description: |
      NPM packages cannot be "rolled back" in the traditional sense. If a bad release is
      published, the strategy is to publish a new version with fixes. NPM does support
      deprecating versions via 'npm deprecate'.

  - name: Hotfix Workflow
    description: |
      Hotfix releases use the same CI/CD workflows but with expedited review process.
      Pre-CI validation is streamlined (3min vs 5min) and automated backport to develop
      branch is executed post-merge.